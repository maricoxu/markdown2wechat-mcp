# å®Œæ•´ Pipeline æµç¨‹ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

å½“ä½¿ç”¨ `publish_wechat` å·¥å…·å‘å¸ƒ Markdown æ–‡ä»¶åˆ°å¾®ä¿¡å…¬ä¼—å·æ—¶ï¼Œå¯ä»¥å¯ç”¨å®Œæ•´çš„è‡ªåŠ¨åŒ–æµç¨‹ï¼š

1. **Mermaid è½¬æ¢**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶è½¬æ¢æ‰€æœ‰ Mermaid ä»£ç å—ä¸º PNG å›¾ç‰‡
2. **ä»£ç å¤‡ä»½**ï¼šä¿å­˜åŸå§‹ Mermaid ä»£ç åˆ° `.mermaid-backup` ç›®å½•
3. **å›¾ç‰‡æ”¶é›†**ï¼šæ”¶é›†æ‰€æœ‰æœ¬åœ°å›¾ç‰‡ï¼ˆåŒ…æ‹¬ Mermaid ç”Ÿæˆçš„å›¾ç‰‡ï¼‰
4. **COS ä¸Šä¼ **ï¼šä¸Šä¼ æ‰€æœ‰å›¾ç‰‡åˆ°è…¾è®¯äº‘ COS
5. **é“¾æ¥æ›¿æ¢**ï¼šè‡ªåŠ¨æ›¿æ¢ Markdown ä¸­çš„æœ¬åœ°å›¾ç‰‡é“¾æ¥ä¸º COS URL
6. **ä¸»é¢˜æ¸²æŸ“**ï¼šåº”ç”¨ä¸»é¢˜æ ·å¼
7. **å‘å¸ƒåˆ°å¾®ä¿¡**ï¼šæäº¤åˆ°å¾®ä¿¡å…¬ä¼—å·è‰ç¨¿ç®±

## ä½¿ç”¨æ–¹æ³•

### é€šè¿‡ MCP å·¥å…·è°ƒç”¨

```json
{
  "name": "publish_wechat",
  "arguments": {
    "filePath": "/path/to/your/article.md",
    "theme": "orangeheart",
    "runPipeline": {
      "convertMermaid": true,
      "uploadImages": true
    }
  }
}
```

### å‚æ•°è¯´æ˜

- `filePath`ï¼ˆå¿…éœ€ï¼‰ï¼šMarkdown æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
- `theme`ï¼ˆå¯é€‰ï¼‰ï¼šä¸»é¢˜ IDï¼Œé»˜è®¤ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„ä¸»é¢˜
- `runPipeline`ï¼ˆå¯é€‰ï¼‰ï¼šPipeline é…ç½®å¯¹è±¡
  - `convertMermaid`ï¼ˆå¸ƒå°”å€¼ï¼Œé»˜è®¤ `false`ï¼‰ï¼šæ˜¯å¦è½¬æ¢ Mermaid ä»£ç å—ä¸ºå›¾ç‰‡
  - `uploadImages`ï¼ˆå¸ƒå°”å€¼ï¼Œé»˜è®¤ `false`ï¼‰ï¼šæ˜¯å¦ä¸Šä¼ å›¾ç‰‡åˆ° COS

### é»˜è®¤è¡Œä¸º

**å¦‚æœä¸è®¾ç½® `runPipeline` å‚æ•°**ï¼Œæˆ–è®¾ç½®ä½†ä¸¤ä¸ªé€‰é¡¹éƒ½ä¸º `false`ï¼š

- âœ… ç›´æ¥è¯»å– Markdown æ–‡ä»¶å†…å®¹ï¼ˆä¸è¿›è¡Œä»»ä½•è½¬æ¢ï¼‰
- âœ… åº”ç”¨ä¸»é¢˜æ ·å¼
- âœ… å‘å¸ƒåˆ°å¾®ä¿¡å…¬ä¼—å·è‰ç¨¿ç®±

**ä¸ä¼šæ‰§è¡Œçš„æ“ä½œï¼š**
- âŒ ä¸ä¼šè½¬æ¢ Mermaid ä»£ç å—ï¼ˆå¦‚æœæ–‡ä»¶ä¸­æœ‰ Mermaid ä»£ç ï¼Œä¼šä¿æŒåŸæ ·ï¼‰
- âŒ ä¸ä¼šä¸Šä¼ å›¾ç‰‡åˆ° COSï¼ˆæœ¬åœ°å›¾ç‰‡è·¯å¾„ä¿æŒåŸæ ·ï¼‰
- âŒ ä¸ä¼šæ›¿æ¢å›¾ç‰‡é“¾æ¥

è¿™æ„å‘³ç€ï¼Œé»˜è®¤æƒ…å†µä¸‹ `publish_wechat` çš„è¡Œä¸ºå°±æ˜¯ä¼ ç»Ÿçš„"ç›´æ¥å‘å¸ƒ"æ¨¡å¼ï¼Œé€‚ç”¨äºï¼š
- æ–‡ä»¶ä¸­æ²¡æœ‰ Mermaid ä»£ç å—
- å›¾ç‰‡å·²ç»ä½¿ç”¨å¤–éƒ¨ URLï¼ˆå¦‚ CDNã€GitHub ç­‰ï¼‰
- åªéœ€è¦å¿«é€Ÿå‘å¸ƒï¼Œä¸éœ€è¦é¢å¤–å¤„ç†

### å·¥ä½œæµç¨‹ç¤ºä¾‹

å‡è®¾ä½ æœ‰ä¸€ä¸ª Markdown æ–‡ä»¶ `article.md`ï¼š

```markdown
---
title: "æˆ‘çš„æ–‡ç« "
---

# æˆ‘çš„æ–‡ç« 

è¿™æ˜¯ä¸€æ®µæ–‡å­—ã€‚

## æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[ç»“æŸ]
```

è¿™é‡Œè¿˜æœ‰ä¸€å¼ æœ¬åœ°å›¾ç‰‡ï¼š

![å›¾ç‰‡](images/local.png)
```

å½“è°ƒç”¨ `publish_wechat` å¹¶å¯ç”¨ Pipeline åï¼š

1. **Mermaid è½¬æ¢**ï¼š
   - æ£€æµ‹åˆ° 1 ä¸ª Mermaid ä»£ç å—
   - è½¬æ¢ä¸º `.assets/article__mmd_0.png`
   - åŸå§‹ä»£ç ä¿å­˜åˆ° `.assets/.mermaid-backup/article__mmd_0.mmd`

2. **å›¾ç‰‡æ”¶é›†**ï¼š
   - æ‰¾åˆ° 2 ä¸ªå›¾ç‰‡ï¼š
     - `.assets/article__mmd_0.png`ï¼ˆMermaid ç”Ÿæˆçš„ï¼‰
     - `images/local.png`ï¼ˆåŸå§‹æœ¬åœ°å›¾ç‰‡ï¼‰

3. **COS ä¸Šä¼ **ï¼š
   - ä¸Šä¼ åˆ° `articles/2025/11/article__mmd_0.png`
   - ä¸Šä¼ åˆ° `articles/2025/11/local.png`

4. **é“¾æ¥æ›¿æ¢**ï¼š
   - åŸæ–‡ä¸­çš„ Mermaid ä»£ç å—è¢«æ›¿æ¢ä¸ºï¼š
     ```markdown
     ![mermaid-1](https://your-cos-url.com/articles/2025/11/article__mmd_0.png)
     ```
   - æœ¬åœ°å›¾ç‰‡é“¾æ¥è¢«æ›¿æ¢ä¸ºï¼š
     ```markdown
     ![å›¾ç‰‡](https://your-cos-url.com/articles/2025/11/local.png)
     ```

5. **å‘å¸ƒ**ï¼š
   - åº”ç”¨ä¸»é¢˜æ ·å¼
   - æäº¤åˆ°å¾®ä¿¡å…¬ä¼—å·è‰ç¨¿ç®±

## æ–‡ä»¶ç»“æ„

å¤„ç†åçš„æ–‡ä»¶ç»“æ„ï¼š

```
your-article.md              # åŸå§‹æ–‡ä»¶ï¼ˆä¿æŒä¸å˜ï¼Œå¤‡ä»½ä¸º .backupï¼‰
.assets/
  â”œâ”€â”€ article__mmd_0.png     # Mermaid ç”Ÿæˆçš„å›¾ç‰‡
  â””â”€â”€ .mermaid-backup/       # åŸå§‹ Mermaid ä»£ç å¤‡ä»½
      â””â”€â”€ article__mmd_0.mmd
```

## COS é…ç½®

ç¡®ä¿å·²æ­£ç¡®é…ç½® COS ä¿¡æ¯ï¼ˆè§ `docs/COS_SETUP_GUIDE.md`ï¼‰ï¼š

```env
COS_SECRET_ID=your_secret_id
COS_SECRET_KEY=your_secret_key
COS_REGION=ap-shanghai
COS_BUCKET=your-bucket-name
COS_BASE_URL=https://your-bucket.cos.region.myqcloud.com
```

## é«˜çº§é…ç½®

### è‡ªå®šä¹‰ COS è·¯å¾„å‰ç¼€

åœ¨è°ƒç”¨ Pipeline æ—¶ï¼Œå¯ä»¥é€šè¿‡ `cosOptions` æŒ‡å®šè·¯å¾„å‰ç¼€ï¼š

```javascript
executePipeline({
  filePath: "article.md",
  convertMermaid: true,
  uploadImages: true,
  cosOptions: {
    keyPrefix: "blog/2025/",  // è‡ªå®šä¹‰å‰ç¼€
    overwrite: false,          // ä¸è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶
  },
});
```

### Mermaid é€‰é¡¹

å¯ä»¥è‡ªå®šä¹‰ Mermaid è½¬æ¢é€‰é¡¹ï¼š

```javascript
executePipeline({
  filePath: "article.md",
  convertMermaid: true,
  mermaidOptions: {
    format: "png",
    scale: 2,
    background: "#ffffff",
    handDrawn: {
      enabled: true,
      roughness: 1.5,
      randomizeColors: true,
    },
  },
});
```

## æµ‹è¯•å®Œæ•´æµç¨‹

ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬ï¼š

```bash
node test/test-pipeline.js
```

è¿™ä¼šï¼š
1. å¤„ç† `test/test-full-pipeline.md`
2. è½¬æ¢æ‰€æœ‰ Mermaid ä»£ç å—
3. ä¸Šä¼ æ‰€æœ‰å›¾ç‰‡åˆ° COS
4. æ›¿æ¢æ‰€æœ‰é“¾æ¥
5. æ˜¾ç¤ºè¯¦ç»†çš„æ‰§è¡Œç»“æœ

## æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶å¤‡ä»½**ï¼šåŸå§‹ Markdown æ–‡ä»¶ä¼šè¢«æ›´æ–°ï¼Œå»ºè®®å¯ç”¨ Git ç‰ˆæœ¬æ§åˆ¶æˆ–æ‰‹åŠ¨å¤‡ä»½
2. **åŸå§‹ä»£ç å¤‡ä»½**ï¼šæ‰€æœ‰åŸå§‹ Mermaid ä»£ç éƒ½ä¼šä¿å­˜åœ¨ `.mermaid-backup` ç›®å½•ä¸­ï¼Œä¾¿äºåç»­ä¿®æ”¹
3. **é”™è¯¯å¤„ç†**ï¼šå¦‚æœæŸä¸ªæ­¥éª¤å¤±è´¥ï¼ŒPipeline ä¼šç»§ç»­æ‰§è¡Œå…¶ä»–æ­¥éª¤ï¼Œå¹¶åœ¨æœ€åæŠ¥å‘Šæ‰€æœ‰é”™è¯¯
4. **COS è·¯å¾„**ï¼šç”Ÿæˆçš„ COS Key æ ¼å¼ä¸º `{keyPrefix}/{year}/{month}/{filename}`
5. **æ‰‹ç»˜é£æ ¼**ï¼šå¦‚æœå¯ç”¨äº†æ‰‹ç»˜é£æ ¼ï¼Œç”˜ç‰¹å›¾å’Œé¥¼å›¾ä¼šè‡ªåŠ¨è·³è¿‡æ‰‹ç»˜æ•ˆæœï¼ˆä¿æŒç²¾ç¡®æ˜¾ç¤ºï¼‰

## æ•…éšœæ’æŸ¥

### Mermaid è½¬æ¢å¤±è´¥

- æ£€æŸ¥æ˜¯å¦å®‰è£…äº† `@mermaid-js/mermaid-cli`
- æ£€æŸ¥ Mermaid ä»£ç è¯­æ³•æ˜¯å¦æ­£ç¡®

### COS ä¸Šä¼ å¤±è´¥

- æ£€æŸ¥ COS é…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆ`.env` æ–‡ä»¶ï¼‰
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æ£€æŸ¥ COS æƒé™è®¾ç½®

### å›¾ç‰‡é“¾æ¥æœªæ›¿æ¢

- ç¡®ä¿å›¾ç‰‡è·¯å¾„æ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äº Markdown æ–‡ä»¶ï¼‰
- æ£€æŸ¥ `collectLocalImagesFromFile` æ˜¯å¦æ­£ç¡®è¯†åˆ«å›¾ç‰‡

## ç¤ºä¾‹è¾“å‡º

æˆåŠŸæ‰§è¡Œåçš„è¾“å‡ºç¤ºä¾‹ï¼š

```
ğŸš€ å¼€å§‹æµ‹è¯•å®Œæ•´ Pipeline æµç¨‹...
ğŸ“„ æ–‡ä»¶: /path/to/article.md

[INFO] å¼€å§‹æ‰§è¡Œ Pipeline
[INFO] æ­¥éª¤ 1: è½¬æ¢ Mermaid ä»£ç å—...
[INFO] æ‰¾åˆ° 2 ä¸ª mermaid ä»£ç å—
[INFO] å·²æ¸²æŸ“ mermaid å›¾è¡¨ 1/2
[INFO] å·²æ¸²æŸ“ mermaid å›¾è¡¨ 2/2
[INFO] å·²è½¬æ¢ 2 ä¸ª Mermaid å›¾è¡¨
[INFO] æ­¥éª¤ 2: æ”¶é›†æœ¬åœ°å›¾ç‰‡...
[INFO] æ‰¾åˆ° 3 ä¸ªæœ¬åœ°å›¾ç‰‡
[INFO] æ­¥éª¤ 3: ä¸Šä¼ å›¾ç‰‡åˆ° COS...
[INFO] æˆåŠŸä¸Šä¼  3 ä¸ªå›¾ç‰‡
[INFO] æ­¥éª¤ 4: å›å†™å›¾ç‰‡é“¾æ¥...
[INFO] å›¾ç‰‡é“¾æ¥å›å†™å®Œæˆ
[INFO] Pipeline æ‰§è¡ŒæˆåŠŸ

âœ… Pipeline æ‰§è¡Œå®Œæˆï¼

ğŸ“Š æ‰§è¡Œç»“æœï¼š
  Mermaid å›¾è¡¨: 2 ä¸ª
  æ”¶é›†çš„å›¾ç‰‡: 3 ä¸ª
  ä¸Šä¼ æˆåŠŸ: 3 ä¸ª
  é”™è¯¯æ•°é‡: 0 ä¸ª

ğŸŒ ä¸Šä¼ çš„å›¾ç‰‡ URLï¼š
  1. https://your-cos-url.com/articles/2025/11/article__mmd_0.png
  2. https://your-cos-url.com/articles/2025/11/article__mmd_1.png
  3. https://your-cos-url.com/articles/2025/11/local.png
```

## æ€»ç»“

å®Œæ•´çš„ Pipeline æµç¨‹å®ç°äº†ï¼š

âœ… **è‡ªåŠ¨åŒ–**ï¼šä¸€é”®å®Œæˆæ‰€æœ‰å›¾ç‰‡å¤„ç†æ­¥éª¤  
âœ… **å¤‡ä»½ä¿æŠ¤**ï¼šåŸå§‹ä»£ç å’Œæ–‡ä»¶éƒ½æœ‰å¤‡ä»½  
âœ… **é”™è¯¯å®¹å¿**ï¼šå•ä¸ªæ­¥éª¤å¤±è´¥ä¸å½±å“å…¶ä»–æ­¥éª¤  
âœ… **çµæ´»é…ç½®**ï¼šæ”¯æŒè‡ªå®šä¹‰è·¯å¾„ã€æ ·å¼ç­‰é€‰é¡¹  
âœ… **å®Œæ•´è¿½è¸ª**ï¼šè¯¦ç»†çš„æ—¥å¿—å’Œç»“æœæŠ¥å‘Š  

ç°åœ¨ä½ å¯ä»¥ä¸“æ³¨äºç¼–å†™å†…å®¹ï¼Œè€Œä¸ç”¨æ‹…å¿ƒå›¾ç‰‡å¤„ç†ã€ä¸Šä¼ å’Œé“¾æ¥æ›¿æ¢çš„ç¹çæ“ä½œï¼

